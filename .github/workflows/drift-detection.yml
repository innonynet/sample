name: Drift Detection

on:
  schedule:
    - cron: '0 0 * * *'  # 毎日 09:00 JST (00:00 UTC)
  workflow_dispatch:      # 手動実行も可能

env:
  TF_CLOUD_ORGANIZATION: "Innospot"
  TF_WORKSPACE: "infra-dev"

jobs:
  detect-drift:
    name: Detect Infrastructure Drift
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Terraform Init
        id: init
        working-directory: stacks/dev
        run: terraform init

      - name: Terraform Plan
        id: plan
        working-directory: stacks/dev
        run: terraform plan -detailed-exitcode
        continue-on-error: true

      - name: Check for Drift
        run: |
          if [ "${{ steps.plan.outputs.exitcode }}" == "2" ]; then
            echo "::error::Infrastructure drift detected! Review the plan output above."
            exit 1
          elif [ "${{ steps.plan.outputs.exitcode }}" == "1" ]; then
            echo "::error::Terraform plan failed!"
            exit 1
          else
            echo "No drift detected. Infrastructure matches configuration."
          fi

      - name: Create Issue on Drift
        if: steps.plan.outputs.exitcode == 2
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Infrastructure Drift Detected - ${new Date().toISOString().split('T')[0]}`;
            const body = `## Drift Detection Alert

            Infrastructure drift was detected during the scheduled drift detection run.

            **Workspace:** ${{ env.TF_WORKSPACE }}
            **Run:** [View workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

            ### Next Steps
            1. Review the Terraform plan output in the workflow run
            2. Determine if the drift is intentional or needs remediation
            3. Either update the Terraform configuration or apply to restore desired state
            `;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['drift', 'infrastructure']
            });
