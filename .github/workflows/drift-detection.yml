name: Drift Detection

on:
  schedule:
    # Run daily at 00:00 UTC (09:00 JST)
    - cron: "0 0 * * *"
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to check (leave empty for all)'
        required: false
        type: choice
        options:
          - all
          - dev
          - stg
          - prd

concurrency:
  group: drift-detection
  cancel-in-progress: false

env:
  CLOUD_PROVIDER: aws

permissions:
  id-token: write
  contents: read

jobs:
  detect-drift-dev:
    name: Detect Drift (dev)
    if: github.event.inputs.environment == 'all' || github.event.inputs.environment == 'dev' || github.event.inputs.environment == ''
    runs-on: ubuntu-latest
    environment: dev
    outputs:
      drift_detected: ${{ steps.plan.outputs.drift_detected }}
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Configure AWS Credentials
        if: env.CLOUD_PROVIDER == 'aws'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN_DEV }}
          aws-region: ap-northeast-1

      - name: Terraform Init
        working-directory: stacks/dev
        run: terraform init -input=false

      - name: Terraform Plan
        id: plan
        working-directory: stacks/dev
        run: |
          set +e
          terraform plan -detailed-exitcode -input=false -no-color > plan.txt 2>&1
          exitcode=$?
          set -e

          cat plan.txt

          if [[ $exitcode -eq 2 ]]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo "::warning::Drift detected in dev environment"
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Plan
        if: steps.plan.outputs.drift_detected == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: drift-plan-dev
          path: stacks/dev/plan.txt

  detect-drift-stg:
    name: Detect Drift (stg)
    if: github.event.inputs.environment == 'all' || github.event.inputs.environment == 'stg' || github.event.inputs.environment == ''
    runs-on: ubuntu-latest
    environment: stg
    outputs:
      drift_detected: ${{ steps.plan.outputs.drift_detected }}
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Configure AWS Credentials
        if: env.CLOUD_PROVIDER == 'aws'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN_STG }}
          aws-region: ap-northeast-1

      - name: Terraform Init
        working-directory: stacks/stg
        run: terraform init -input=false

      - name: Terraform Plan
        id: plan
        working-directory: stacks/stg
        run: |
          set +e
          terraform plan -detailed-exitcode -input=false -no-color > plan.txt 2>&1
          exitcode=$?
          set -e

          cat plan.txt

          if [[ $exitcode -eq 2 ]]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo "::warning::Drift detected in stg environment"
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Plan
        if: steps.plan.outputs.drift_detected == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: drift-plan-stg
          path: stacks/stg/plan.txt

  detect-drift-prd:
    name: Detect Drift (prd)
    if: github.event.inputs.environment == 'all' || github.event.inputs.environment == 'prd' || github.event.inputs.environment == ''
    runs-on: ubuntu-latest
    environment: prd
    outputs:
      drift_detected: ${{ steps.plan.outputs.drift_detected }}
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7.0"
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}

      - name: Configure AWS Credentials
        if: env.CLOUD_PROVIDER == 'aws'
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ vars.AWS_ROLE_ARN_PRD }}
          aws-region: ap-northeast-1

      - name: Terraform Init
        working-directory: stacks/prd
        run: terraform init -input=false

      - name: Terraform Plan
        id: plan
        working-directory: stacks/prd
        run: |
          set +e
          terraform plan -detailed-exitcode -input=false -no-color > plan.txt 2>&1
          exitcode=$?
          set -e

          cat plan.txt

          if [[ $exitcode -eq 2 ]]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo "::error::Drift detected in prd environment!"
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload Plan
        if: steps.plan.outputs.drift_detected == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: drift-plan-prd
          path: stacks/prd/plan.txt

  notify:
    name: Notify
    needs: [detect-drift-dev, detect-drift-stg, detect-drift-prd]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Create Summary
        run: |
          echo "## Drift Detection Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | Drift Detected |" >> $GITHUB_STEP_SUMMARY
          echo "|-------------|----------------|" >> $GITHUB_STEP_SUMMARY
          echo "| dev | ${{ needs.detect-drift-dev.outputs.drift_detected == 'true' && '‚ö†Ô∏è Yes' || '‚úÖ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| stg | ${{ needs.detect-drift-stg.outputs.drift_detected == 'true' && '‚ö†Ô∏è Yes' || '‚úÖ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| prd | ${{ needs.detect-drift-prd.outputs.drift_detected == 'true' && 'üö® Yes' || '‚úÖ No' }} |" >> $GITHUB_STEP_SUMMARY

      # Uncomment for Slack notification
      # - name: Slack Notification
      #   if: needs.detect-drift-dev.outputs.drift_detected == 'true' || needs.detect-drift-stg.outputs.drift_detected == 'true' || needs.detect-drift-prd.outputs.drift_detected == 'true'
      #   uses: slackapi/slack-github-action@v1
      #   with:
      #     payload: |
      #       {
      #         "text": "‚ö†Ô∏è Infrastructure drift detected!",
      #         "attachments": [
      #           {
      #             "color": "warning",
      #             "fields": [
      #               {"title": "dev", "value": "${{ needs.detect-drift-dev.outputs.drift_detected }}", "short": true},
      #               {"title": "stg", "value": "${{ needs.detect-drift-stg.outputs.drift_detected }}", "short": true},
      #               {"title": "prd", "value": "${{ needs.detect-drift-prd.outputs.drift_detected }}", "short": true}
      #             ]
      #           }
      #         ]
      #       }
      #   env:
      #     SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
